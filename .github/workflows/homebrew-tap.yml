name: Update Homebrew Tap

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish to Homebrew tap (example: v0.7.2)'
        required: true

permissions:
  contents: read

jobs:
  update-tap:
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.event.workflow_run.head_branch }}
      REPOSITORY: ${{ github.repository }}
      TAP_REPOSITORY: chandika/homebrew-tap
      FORMULA_PATH: Formula/mirage-proxy.rb
    steps:
      - name: Validate required secret
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${HOMEBREW_TAP_TOKEN}" ]; then
            echo "Missing required secret: HOMEBREW_TAP_TOKEN"
            exit 1
          fi

      - name: Resolve and validate tag
        run: |
          set -euo pipefail
          if [ -z "${TAG}" ]; then
            echo "TAG is empty"
            exit 1
          fi
          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "TAG '${TAG}' is not a semver tag"
            exit 1
          fi
          echo "Using tag: ${TAG}"

      - name: Download binaries and compute SHA256s
        id: checksums
        run: |
          set -euo pipefail
          VERSION="${TAG#v}"
          BASE="https://github.com/${REPOSITORY}/releases/download/${TAG}"

          for PLATFORM in macos-arm64 macos-x86_64 linux-arm64 linux-x86_64; do
            FILE="mirage-proxy-v${VERSION}-${PLATFORM}"
            URL="${BASE}/${FILE}"
            echo "Downloading ${URL} ..."

            # Retry because release assets can appear a little after workflow completion.
            ok=false
            for attempt in 1 2 3 4 5; do
              if curl -fsSL "$URL" -o "/tmp/${FILE}"; then
                ok=true
                break
              fi
              echo "Attempt ${attempt} failed; retrying in 20s..."
              sleep 20
            done

            if [ "$ok" != "true" ]; then
              echo "Failed to download ${URL}"
              exit 1
            fi

            SHA256="$(sha256sum "/tmp/${FILE}" | awk '{print $1}')"
            KEY="${PLATFORM//-/_}"
            echo "sha256_${KEY}=${SHA256}" >> "$GITHUB_OUTPUT"
          done

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TAP_REPOSITORY }}
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: tap

      - name: Update formula
        env:
          VERSION: ${{ steps.checksums.outputs.version }}
          SHA256_MACOS_ARM64: ${{ steps.checksums.outputs.sha256_macos_arm64 }}
          SHA256_MACOS_X86_64: ${{ steps.checksums.outputs.sha256_macos_x86_64 }}
          SHA256_LINUX_ARM64: ${{ steps.checksums.outputs.sha256_linux_arm64 }}
          SHA256_LINUX_X86_64: ${{ steps.checksums.outputs.sha256_linux_x86_64 }}
        run: |
          set -euo pipefail
          cat > tap/${FORMULA_PATH} << EOF
          class MirageProxy < Formula
            desc "Invisible sensitive data filter for LLM APIs"
            homepage "https://github.com/${REPOSITORY}"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${REPOSITORY}/releases/download/v#{version}/mirage-proxy-v#{version}-macos-arm64"
                sha256 "${SHA256_MACOS_ARM64}"
              else
                url "https://github.com/${REPOSITORY}/releases/download/v#{version}/mirage-proxy-v#{version}-macos-x86_64"
                sha256 "${SHA256_MACOS_X86_64}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/${REPOSITORY}/releases/download/v#{version}/mirage-proxy-v#{version}-linux-arm64"
                sha256 "${SHA256_LINUX_ARM64}"
              else
                url "https://github.com/${REPOSITORY}/releases/download/v#{version}/mirage-proxy-v#{version}-linux-x86_64"
                sha256 "${SHA256_LINUX_X86_64}"
              end
            end

            def install
              binary = Dir["mirage-proxy-*"].first || "mirage-proxy"
              bin.install binary => "mirage-proxy"
            end

            test do
              assert_match "mirage-proxy", shell_output("#{bin}/mirage-proxy --version")
            end
          end
          EOF
          sed -i 's/^          //' tap/${FORMULA_PATH}

      - name: Commit and push formula update
        env:
          VERSION: ${{ steps.checksums.outputs.version }}
        run: |
          set -euo pipefail
          cd tap
          if git diff --quiet -- "${FORMULA_PATH}"; then
            echo "No formula changes detected."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${FORMULA_PATH}"
          git commit -m "mirage-proxy ${VERSION}"
          git push
